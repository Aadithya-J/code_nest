
volumes:
  auth_pgdata:
  auth_keys:

services:
  postgres:
    image: postgres:16-alpine
    container_name: auth_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${AUTH_POSTGRES_DB:-auth_db}
      POSTGRES_USER: ${AUTH_POSTGRES_USER:-auth_user}
      POSTGRES_PASSWORD: ${AUTH_POSTGRES_PASSWORD:-auth_pass}
    ports:
      - "${AUTH_POSTGRES_PORT:-5432}:5432"
    volumes:
      - auth_pgdata:/var/lib/postgresql/data

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth_service
    depends_on:
      - postgres
    restart: unless-stopped
    environment:
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT:-50051}
      DATABASE_URL: postgres://${AUTH_POSTGRES_USER:-auth_user}:${AUTH_POSTGRES_PASSWORD:-auth_pass}@postgres:5432/${AUTH_POSTGRES_DB:-auth_db}?sslmode=disable
      DB_SCHEMA: ${AUTH_DB_SCHEMA:-auth}
      JWT_SECRET: ${AUTH_JWT_SECRET:-super-secret-dev-key}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-set-me}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-set-me}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:-http://localhost:3000/auth/google/callback}
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:3000}
      GITHUB_APP_ID: ${GITHUB_APP_ID:-0}
      GITHUB_APP_SLUG: ${GITHUB_APP_SLUG:-set-me}
      GITHUB_PRIVATE_KEY_PATH: /app/github_app.pem
    ports:
      - "${AUTH_GRPC_PORT:-50051}:50051"
      - "${AUTH_JWKS_PORT:-8081}:8081"
    volumes:
      - auth_keys:/app/keys
      - ./secrets/github_app.pem:/app/github_app.pem:ro
